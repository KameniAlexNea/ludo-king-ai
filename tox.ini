[tox]
envlist = format, test
skipsdist = True
skip_missing_interpreters = True
requires =
    tox-uv

[testenv:test]
description = Run tests with coverage
deps =
    -e .
    coverage>=7.0
    pytest>=7.0
    pytest-cov>=4.0
commands =
    coverage run -m pytest tests
    coverage report -m --include="src/*" --omit="*/test_*"
    coverage html --include="src/*" --omit="*/test_*"
    coverage xml --include="src/*" --omit="*/test_*"

[testenv:test-ci]
description = Run tests with coverage for CI (no HTML report)
deps =
    -e .
    coverage>=7.0
    pytest>=7.0
    pytest-cov>=4.0
commands =
    coverage run -m pytest tests
    coverage report -m --include="src/*" --omit="*/test_*" --fail-under=80
    coverage xml --include="src/*" --omit="*/test_*"

[testenv:format]
description = Format code with black and ruff
deps =
    black>=23.0,<25.0
    ruff>=0.1.0
    isort>=5.0
commands =
    isort tests/ src/
    black src/ tests/
    ruff check src/ tests/ --fix --ignore E712
    ruff format src/ tests/

[testenv:quality-gate]
description = Enforce quality gates (fail if thresholds exceeded)
deps =
    radon>=6.0.1
    xenon>=0.9.0
    pylint>=3.0.0
commands =
    # Fail if any function has complexity > 10 (B grade)
    xenon --max-absolute B --max-modules A --max-average A src/
    
    # Fail if maintainability index < 65
    radon mi src/ -n B -s
    
    # Fail if pylint score < 8.0
    pylint src/ --fail-under=8.0 --disable=C0111,R0903